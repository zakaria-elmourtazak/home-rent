@using Microsoft.AspNetCore.Identity
@model MyMvcAuthProject.Models.MessagesPageViewModel
@inject UserManager<ApplicationUser> UserManager

@{
    ViewData["Title"] = "Messages";
    var convs = Model?.Conversations ?? Enumerable.Empty<MyMvcAuthProject.Models.Conversation>();
    var current = Model?.CurrentConversation;
    var currentId = Model?.CurrentConversationId?.ToString() ?? "";
    var userId =  UserManager.GetUserAsync(User).Result?.Id ?? "";


}

<main class="container mx-auto px-4 py-8 flex flex-col md:flex-row gap-8">
    @await Html.PartialAsync("_AccountSidebar")

    <section class="flex-1">
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                <div>
                    <h2 class="text-2xl font-bold">Messages</h2>
                    <p class="text-gray-600">Conversations with property owners and tenants</p>
                </div>
                <div class="flex flex-wrap gap-3">
                    <select class="border rounded-lg p-2 input text-gray-500 text-sm w-40">
                        <option>All Conversations</option>
                        <option>Unread</option>
                        <option>Flagged</option>
                    </select>
                    <div class="relative">
                        <input id="messages-search" type="text" placeholder="Search messages"
                            class="border rounded-lg pl-10 pr-4 py-2 w-full input">
                        <i class="fas fa-search absolute left-3 top-3.5 text-gray-400"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Conversations list (left column) -->
            <aside class="bg-white rounded-xl shadow-sm border border-gray-100 p-4" style="height: 650px;">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="font-semibold">Conversations</h3>
                    <a class="text-primary text-sm">New</a>
                </div>

                <div id="conversations-list"
                    class="divide-y overflow-auto max-h-[55vh] mt-3 scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100">
                    @foreach (var c in convs)
                    {
                        var lastMsg = c.Messages?.OrderByDescending(m => m.SentAt).FirstOrDefault();
                        <a data-conv-id="@c.Id" id="conv-@c.Id"
                            class="mb-2 bg-gray-50 hover:bg-green-100 cursor-pointer conv-item message-border block p-3 flex items-start gap-3 rounded-xl @(current != null && current.Id == c.Id ? "bg-gray-50" : "")">
                            <div class="flex-1">
                                <div class="flex justify-between items-start ">
                                    <div class="font-medium text-gray-500">@(!string.IsNullOrWhiteSpace(c.Title) ? c.Title
                                                                            :
                                                                            $"Conversation #{c.Id}")</div>
                                    <div class="text-xs text-gray-500">@c.LastUpdated.ToLocalTime().ToString("h:mm")</div>
                                </div>
                                <div class="text-sm text-gray-500 text-xs truncate mt-1 ">
                                    @if (lastMsg != null)
                                    {
                                        <i><b>@($"{lastMsg.SenderName}")</b></i>
                                        @($" {lastMsg.Content.Substring(0, Math.Min(lastMsg.Content.Length, 50))}")
                                    }
                                    else
                                    {
                                        <span class="text-gray-400">No messages yet</span>
                                    }
                                </div>
                            </div>
                        </a>
                    }
                    @if (!convs.Any())
                    {
                        <div class="p-4 text-sm text-gray-500">No conversations yet. Contact a property owner from a
                            property page to start.</div>
                    }
                </div>
            </aside>

            <!-- Conversation detail (right columns) -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 lg:col-span-2 flex flex-col"
                style="height: 650px;">
                <div class="p-4 border-b flex items-center justify-between">
                    <div>
                        <h3 id="conversation-title" class="font-semibold">@((current?.Title) ??
                                                        "Select a conversation")</h3>
                        <p id="conversation-sub" class="text-sm text-gray-500 mt-2">@("Owned by • " +
                                                        current?.Property?.User?.UserName ?? "")
                        </p>
                    </div>
                    <div class="space-x-2">
                        <button class="text-primary"><i class="fas fa-flag"></i></button>
                        <button class="text-gray-500"><i class="fas fa-ellipsis-h"></i></button>
                    </div>
                </div>

                <!-- messages list -->
                <div id="messages-list" data-conv="@currentId"
                    class="p-4 space-y-4 overflow-y-auto scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100 flex-1"
                    style="scroll-behavior: smooth;"> @* initial render from server if present *@
                    @if (current?.Messages != null && current.Messages.Any())
                    {
                        foreach (var m in current.Messages.OrderBy(m => m.SentAt))
                        {
                            <div data-msg-id="@m.Id"
                                class="flex flex-col mb-2 @(m.SenderId == userId ? "items-end" : "items-start")">
                                <div class="text-xs text-gray-500 italic mx-2 mb-0">@m.SenderName</div>
                                <div
                                    class="@("mt-2 p-3 pr-8 rounded-xl message-border " + (m.SenderId == userId ? "bg-green-50 border-green-100 self-end " : "bg-gray-50"))">
                                    @m.Content
                                    <div
                                    style="padding-left: 80px;"
                                     class="text-xs text-gray-400 italic mr-3 flex justify-end ">
                                        @m.SentAt.ToLocalTime().ToString("h:mm tt")
                                    </div>
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <div class="text-sm text-gray-500">No messages in this conversation. Use the input below to send the
                            first message.</div>
                    }
                </div>

                <!-- send form -->
                <div class="p-4 border-t">
                    <form class="flex gap-3 chat-send-form" method="post" action="/Messages/SendMessage"
                        data-conversation-id="@currentId">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="conversationId" value="@currentId" />
                        <input name="content" type="text" placeholder="Type your message..." autocomplete="off"
                            class="flex-1 border rounded-lg p-3 input" />
                        <button type="submit"
                            class="bg-primary text-white px-4 py-3 rounded-lg hover:bg-secondary transition button">Send</button>
                    </form>
                </div>
            </div>
        </div>
    </section>
</main>

<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>
<script src="~/js/chat.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const convLinks = document.querySelectorAll('.conv-item');
        const messagesList = document.getElementById('messages-list');
        const convTitle = document.getElementById('conversation-title');
        const convSub = document.getElementById('conversation-sub');
        const chatForm = document.querySelector('.chat-send-form');
        const chatInput = chatForm?.querySelector('input[name="content"]');
        let activeConvId = chatForm?.dataset?.conversationId || null;
        // add current user id so client can mark "you"
        const currentUserId = '@userId';
        // track the active conversation DOM element so we can toggle its background
        let activeConvElement = activeConvId ? document.querySelector(`.conv-item[data-conv-id="${activeConvId}"]`) : null;

        function setActiveConvElement(el) {
            if (activeConvElement && activeConvElement !== el) {
                activeConvElement.classList.remove('bg-green-100');
                activeConvElement.classList.remove('border-green-200');
                const convTitle = activeConvElement.querySelector('.font-medium')
                if (convTitle) {
                    convTitle.classList.remove('text-gray-800');
                }
            }
            if (el) {
                el.classList.add('bg-green-100');
                el.classList.add('border-green-200');
                const convTitle = el.querySelector('.font-medium')
                if (convTitle) {
                    convTitle.classList.add('text-gray-800');
                }
            }
            activeConvElement = el;
        }

        function joinConv(convId) {
            if (!convId) return;
            if (window.chat?.startConnection) {
                chat.startConnection().then(() => chat.joinConversation(convId)).catch(() => { });
            } else {
                if (window.chat?.joinConversation) chat.joinConversation(convId);
            }
        }
        function leaveConv(convId) {
            if (!convId) return;
            if (window.chat?.leaveConversation) chat.leaveConversation(convId);
        }

           function renderMessagesArray(messages) {
            console.log('renderMessagesArray called with messages:', messages);
            messagesList.innerHTML = '';
            if (!messages || messages.length === 0) {
                messagesList.innerHTML = '<div class="text-sm text-gray-500">No messages in this conversation.</div>';
                return;
            }
            messages.forEach(m => {
                if (messagesList.querySelector(`[data-msg-id="${m.id}"]`)) return; // skip duplicates

                // determine if this message is from the current user
                const isYou = m.isYou ;

                const item = document.createElement('div');
                item.setAttribute('data-msg-id', m.id);
                item.className = isYou ? 'flex flex-col mb-2 items-end' : 'flex flex-col mb-2 items-start';

                const meta = document.createElement('div');
                meta.className = 'text-xs text-gray-500 italic mx-2 mb-0';
                const dt = m.sentAt ? new Date(m.sentAt) : new Date();
                meta.textContent = `${isYou ? 'You' : (m.senderName || '')}`;

                const body = document.createElement('div');
                let className =  'mt-2 p-3 rounded-xl message-border ' ;
                if(isYou)
                className += 'bg-green-50 border-green-100 self-end';
                else
                className += 'bg-gray-50';
                body.className = className;
                body.textContent = m.content || '';

                const time = document.createElement('div');
                time.className = 'text-xs text-gray-400 italic mr-3 flex justify-end';
                time.style.paddingLeft = '80px';
                time.textContent = dt.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                item.appendChild(meta);
                item.appendChild(body);
                body.appendChild(time);
                messagesList.appendChild(item);
            });
            messagesList.scrollTop = messagesList.scrollHeight;
        }
        // load conversation messages via AJAX and update right panel
        convLinks.forEach(link => {
            link.addEventListener('click', function (e) {
                e.preventDefault();
                const id = this.dataset.convId;
                if (!id) return;
                if (id === activeConvId) return; // already active

                // visually mark clicked conversation as active
                setActiveConvElement(this);

                // leave previous group
                leaveConv(activeConvId);

                fetch(`/Messages/ConversationMessages?id=${encodeURIComponent(id)}`, { credentials: 'same-origin' })
                    .then(r => {
                        console.log('Fetched conversation messages response:', r);
                        if (!r.ok) throw new Error('Failed to load conversation');
                        return r.json();
                    })
                    .then(data => {

                        activeConvId = data.id?.toString() || id;
                        // ensure the active element reflects the new id (in case element id/value differs)
                        const newActiveEl = document.querySelector(`.conv-item[data-conv-id="${activeConvId}"]`) || this;
                        setActiveConvElement(newActiveEl);

                        // update form conversation id
                        if (chatForm) {
                            chatForm.dataset.conversationId = activeConvId;
                            const hid = chatForm.querySelector('input[name="conversationId"]');
                            if (hid) hid.value = activeConvId;
                        }
                        // update header
                        convTitle.textContent = data.title || `Conversation #${activeConvId}`;
                        convSub.textContent = "Owned by • User1" ;

                        // make sure each message has senderId or isYou if possible before rendering
                        const msgs = (data.messages || []).map(m => {
                            return {
                                id: m.id,
                                senderId: m.senderId,
                                senderName: m.senderName,
                                content: m.content,
                                sentAt: m.sentAt,
                                isYou: !!m.isYou || (m.senderId && m.senderId.toString() === currentUserId)
                            };
                        });
                        renderMessagesArray(msgs);

                        // join SignalR group for realtime updates
                        joinConv(activeConvId);
                    })
                    .catch(err => console.error(err));
            });
        });

        // send message with AJAX and append returned DTO
        chatForm?.addEventListener('submit', function (ev) {
            ev.preventDefault();
            const content = chatInput.value?.trim();
            if (!content) return;
            const conversationId = chatForm.querySelector('input[name="conversationId"]').value;
            const url = chatForm.action;
            const token = chatForm.querySelector('input[name="__RequestVerificationToken"]')?.value;

            const body = new URLSearchParams();
            body.append('conversationId', conversationId);
            body.append('content', content);

            fetch(url, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'RequestVerificationToken': token,
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: body.toString(),
                credentials: 'same-origin'
            })
                .then(async res => {
                    if (!res.ok) {
                        console.error('send failed', res.status);
                        return;
                    }
                    const dto = await res.json().catch(() => null);
                    if (dto) {
                        // ensure DTO is flagged as from current user so client renders it as "you"
                        dto.isYou = true;
                        dto.senderId = dto.senderId || currentUserId;

                        // append without removing existing messages
                        if (!messagesList.querySelector(`[data-msg-id="${dto.id}"]`)) {
                            const existing = Array.from(messagesList.querySelectorAll('[data-msg-id]')).map(n => {
                                return {
                                    id: n.getAttribute('data-msg-id'),
                                    senderName: n.querySelector('.text-xs')?.textContent || '',
                                    content: n.querySelector('.message-border')?.firstChild?.textContent || '',
                                    sentAt: null,
                                    isYou: n.classList.contains('items-end')
                                };
                            });

                            renderMessagesArray([...existing, dto].map(x => ({
                                id: x.id,
                                senderId: x.senderId,
                                senderName: x.senderName,
                                content: x.content,
                                sentAt: x.sentAt || dto.sentAt || new Date().toISOString(),
                                isYou: !!x.isYou
                            })));
                        }
                        chatInput.value = '';
                    }
                })
                .catch(err => console.error(err));
        });

        // join currently active conversation (on page load, if present)
        if (activeConvId) {
            // ensure the visual state is correct on initial load
            setActiveConvElement(activeConvElement);
            joinConv(activeConvId);
        }
    });
</script>